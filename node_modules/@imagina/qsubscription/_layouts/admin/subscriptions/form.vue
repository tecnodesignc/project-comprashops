<template>
   <div id="adminProductsFrom">
      <q-no-ssr>
         <!--Content-->
         <div class="relative-position q-mb-lg backend-page">
            <!--Data-->
            <q-form @submit="updateItem" ref="formRegister" class="box relative-position" autocomplete="off"
                    @validation-error="$alert.error($tr('ui.message.formInvalid'))">
               <div class="row gutter-x-sm">
                  <div class="col-12 col-md-8 q-pa-lg">
                     <q-select outlined
                               v-model="form.userId"
                               :options="userOptions"
                               option-label="label"
                               dense
                               emit-value
                               map-options
                               label="Usuario"/>

                     <q-input dense mask="date"
                              v-model="form.initDate"
                              color="primary"
                              label="Fecha de Inicio"
                              outlined placeholder="YYYY/MM/DD">
                        <template v-slot:append>
                           <q-icon name="fas fa-calendar-day"/>
                           <q-popup-proxy
                                   ref="qDateProxy"
                                   transition-show="scale"
                                   transition-hide="scale"
                           >
                              <q-date
                                      v-model="form.initDate"
                                      @input="() => $refs.qDateProxy.hide()"
                              />
                           </q-popup-proxy>
                        </template>
                     </q-input>
                     <q-input dense
                              mask="date"
                              v-model="form.endDate"
                              color="primary"
                              label="Fecha de RenovaciÃ²n"
                              outlined
                              placeholder="YYYY/MM/DD">
                        <template v-slot:append>
                           <q-icon name="fas fa-calendar-day"/>
                           <q-popup-proxy
                                   ref="qDateProxy"
                                   transition-show="scale"
                                   transition-hide="scale"
                           >
                              <q-date
                                      v-model="form.endDate"
                                      @input="() => $refs.qDateProxy.hide()"
                              />
                           </q-popup-proxy>
                        </template>
                     </q-input>
                     <q-select
                             :label="`${$tr('ui.form.status')}`"
                             v-model="form.status"
                             outlined
                             dense
                             emit-value
                             map-options
                             :options="[
                                 {label : $tr('ui.label.disabled'), value : 0},
                                 {label : $tr('ui.label.enabled'), value :1},
                                  {label : 'Pendiente', value :2},
                                            ]"/>
                  </div>
                  <div class="col-12 col-md-4 q-pa-lg">
                     <q-select outlined
                               v-model="product"
                               :options="productOptions"
                               option-label="label"
                               dense
                               emit-value
                               map-options
                               @input="getPlans(product)"
                               label="Paquete"/>
                     <q-select outlined
                               v-model="form.planId"
                               :options="planOptions"
                               option-label="label"
                               dense
                               emit-value
                               map-options
                               label="Plan"/>
                     <q-input
                             prefix="$"
                             v-model="value"
                             outlined
                             dense
                             label="Valor"
                             readonly
                     />
                     <q-toggle
                             v-model="form.active"
                             checked-icon="check"
                             color="green"
                             label="Activo"
                             unchecked-icon="clear"
                     />

                  </div>
                  <!--Update button-->
                  <div class="text-right q-mt-sm q-pa-lg">
                     <q-btn color="positive" :loading="loading" type="submit"
                            icon="fas fa-save" :label="$tr('ui.label.save')"/>
                  </div>
                  <!--Inner loafing-->
                  <inner-loading :visible="loading"/>
               </div>
            </q-form>
         </div>
      </q-no-ssr>

   </div>
</template>
<script>
   //Components
   import recursiveList from 'src/components/master/recursiveListSelect'
   import schedulesForm from 'src/components/master/schedules'

   export default {
      props: {},
      components: {recursiveList, schedulesForm},
      watch: {},
      mounted() {
         this.$nextTick(function () {
            this.init()
         })
      },
      data() {
         return {
            loading: false,
            success: false,
            form: {
               firstName: null,
               lastName: null,
               email: null,
               fields: {},
               status: null
            },
            product: null,
            value: null,
            userOptions: [],
            productOptions: [],
            planOptions: [],
         }
      },
      computed: {},
      methods: {
         //Init
         async init() {
            this.loading=true
            //Search id in params URL
            await this.getUser()
            await this.getData()//Get data if is edit
            await this.getProducts()
         },
         //Get users
         getUser() {
            return new Promise((resolve, reject) => {
               let params = {
                  remember: false,
                  params: {}
               };//params
               this.$crud.index("apiRoutes.quser.users", params).then(response => {
                  this.userOptions = this.$array.select(response.data, {label: 'fullName', id: 'id'});
                  resolve(response.data)
               }).catch(error => {
                  resolve(false)//Resolve
                  this.loading.page = false
                  this.$alert.error({message: this.$tr('ui.message.recordNoUpdated'), pos: 'bottom'})
               });
            })
         },
         //Get data item
         getData() {
            return new Promise((resolve, reject) => {
               this.loading = true
               const itemId = this.$route.params.id
               if (itemId) {
                  //Params
                  let params = {
                     refresh: true,
                     params: {
                        include: 'user,plan',
                        filter: {allTranslations: true}
                     }
                  }
                  //Request
                  this.$crud.show('apiRoutes.qsubscription.subscriptions', itemId, params).then(response => {
                     this.form = this.$clone(response.data);
                     this.form.userId = parseInt(this.form.userId)
                     this.form.status = parseInt(this.form.status)
                     if (this.form.planId) {
                        this.planOptions = [{
                           label: this.$clone(this.form.plan.name),
                           id: this.$clone(this.form.plan.id),
                           value: this.$clone(this.form.plan.id)
                        }]
                        this.form.planId = parseInt(this.form.planId)
                        this.product = {
                           label: this.$clone(this.form.plan.product.name),
                           id: this.$clone(this.form.plan.product.id),
                        }
                        this.value = this.$n(this.form.plan.price)
                     }

                     this.loading = false;
                     resolve(true)//Resolve
                  }).catch(error => {
                     this.$alert.error({message: this.$tr('ui.message.errorRequest'), pos: 'bottom'})
                     this.loading = false
                     reject(false)//Resolve
                  })
               } else {
                  resolve(true)//Resolve
               }
            })
         },
         //Update Product
         async updateItem() {
            this.loading = true
            const itemId = this.$route.params.id
            this.$crud.update('apiRoutes.qsubscription.subscriptions', itemId , this.form).then(response => {
               this.$alert.success({message: `${this.$tr('ui.message.recordUpdated')}`})
               this.$router.push({name: 'qsubscription.admin.subscription.index'})//Redirect to index
               this.loading = false
            }).catch(error => {
               this.loading = false
               console.error('UPDATE ERROR',error)
               this.$alert.error({message: this.$tr('ui.message.recordNoUpdated'), pos: 'bottom'})
            })

         },
         getProducts() {
            let params = {
               refresh: true,
               params: {
                  include: '',
               }
            }
            //Request
            this.$crud.index('apiRoutes.qsubscription.products', params).then(response => {
               this.productOptions = this.$array.select(response.data, {label: 'name', id: 'id'});
            }).catch(error => {
               this.$alert.error({message: this.$tr('ui.message.errorRequest'), pos: 'bottom'})
               this.loading = false
            })
         },
         getPlans(key) {
            let params = {
               refresh: true,
               params: {
                  include: '',
                  filter: {
                     productId: key
                  }
               }
            }
            //Request
            this.$crud.index('apiRoutes.qsubscription.plans', params).then(response => {
               this.planOptions = this.$array.select(response.data, {label: 'name', id: 'id'});
            }).catch(error => {
               this.$alert.error({message: this.$tr('ui.message.errorRequest'), pos: 'bottom'})
               this.loading = false
            })
         }
      }
   }
</script>
<style lang="stylus">
</style>
