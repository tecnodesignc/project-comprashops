<template>
  <div>
    <q-btn
      dense
      flat
      round
      @click="showPanelUsers = !showPanelUsers">
      <q-icon name="message"/>
    </q-btn>
    <transition
      appear
      enter-active-class="animated fadeInLeft"
      leave-active-class="animated fadeOutLeft">
      <div
        v-if="showPanelUsers"
        class="absolute float-div bg-white">
        <q-toolbar class="bg-primary text-white shadow-1 q-py-lg">
          <q-toolbar-title>
            <q-btn
              dense
              flat
              round
              @click="showPanelUsers = !showPanelUsers"
              icon="keyboard_backspace"/>
            Nuevo Chat
          </q-toolbar-title>
        </q-toolbar>
        <q-scroll-area
          ref="scrollAreaUsers"
          style="height: 78vh">
          <q-list>
            <q-infinite-scroll @load="getUsers" :offset="550" ref="infinityScrollOfferStore">
              <div v-for="(item,i) in items" :key="i">
              <div v-for="(user, index) in item.users" :key="index">
              <userLabel :user="user"/>
              </div>
              </div>
              <template v-slot:loading v-if="loadingScroll">
                <div class="row justify-center q-my-md">
                  <q-spinner-dots color="primary" size="40px"/>
                </div>
              </template>
            </q-infinite-scroll>
          </q-list>
        </q-scroll-area>
      </div>
    </transition>
  </div>
</template>

<script>
  import userLabel from '@imagina/qchat/_components/admin/userLabel'

  export default {
    components:{
      userLabel
    },
    data () {
      return {
        visible: false,
        showPanelUsers: false,
        items:[],
        users: [],
        page: 1,
        loadingScroll: true,
        totalPage: 0,
        take: 8,
        currentUser: {},
      }
    },
    created () {
      this.$root.$on('newNewConversationMessage', this.handlerNewNewConversationMessage)
    },
    beforeDestroy () {

      this.$root.$off('newNewConversationMessage', this.handlerNewNewConversationMessage)
    },
    mounted() {
      this.$nextTick( () => {
      })
    },
    methods: {

      getUsers(index, done) {
        return new Promise((resolve, reject) => {
          let currentPage = this.page
          //Validate last page before do request
          if ((currentPage != 1) && (currentPage > this.totalPage)) return this.$refs.infinityScrollOfferStore.stop()
          this.visible = true;
          this.$crud.index("apiRoutes.quser.users", {
            params: {
              filter: {},
              take: this.take,
              page: currentPage
            }
          }).then(response => {
            this.items.push({users: response.data});
            this.totalPage = response.meta.page.lastPage
            this.page++
            this.numSlide++
            this.visible = false;
            resolve(true)//Resolve
            done()
          }).catch(error => {
            return this.$refs.infinityScroll.stop()
            done()
          });
        })
      },

      handlerNewNewConversationMessage(event){
        this.showPanelUsers = !this.showPanelUsers
      }
    }
  }
</script>

<style>
  .float-div{
    width: 100%;
    left: 0;
    top: 0;
    z-index: 100
  }
</style>
